all: firejail firejail.1

PREFIX=@prefix@
VERSION=@PACKAGE_VERSION@
NAME=@PACKAGE_NAME@

H_FILE_LIST       = $(wildcard *.[h])
C_FILE_LIST       = $(wildcard *.c)
OBJS = $(C_FILE_LIST:.c=.o)
BINOBJS =  $(foreach file, $(OBJS), $file)
CFLAGS += -ggdb -O2 -DVERSION='"$(VERSION)"' -fstack-protector-all -D_FORTIFY_SOURCE=2 -fPIE -pie -Wformat -Wformat-security
LDFLAGS:=-Wl,-z,relro

%.o : %.c $(H_FILE_LIST)
	$(CC) $(CFLAGS) $(INCLUDE) -c $< -o $@

firejail: $(OBJS)
	$(CXX)  $(LDFLAGS) -o $@ $(OBJS) $(LIBS)

firejail.1: man/firejail.txt
	./mkman.sh $(VERSION) man/firejail.txt firejail.1

clean:; rm -f *.o firejail firejail.1 firejail.1.gz

distclean: clean
	rm -fr Makefile autom4te.cache config.log config.status config.h

install: all
	strip firejail
	mkdir -p $(PREFIX)/bin
	install -c -m 0755 firejail $(PREFIX)/bin/.
	chmod u+s $(PREFIX)/bin/firejail
	mkdir -p $(PREFIX)/share/doc/firejail
	install -c -m 0644 COPYING $(PREFIX)/share/doc/firejail/.
	install -c -m 0644 README $(PREFIX)/share/doc/firejail/.
	install -c -m 0644 RELNOTES $(PREFIX)/share/doc/firejail/.
	mkdir -p /etc/firejail
	install -c -m 0644 profiles/firefox.profile /etc/firejail/.
	install -c -m 0644 profiles/firefox.profile /etc/firejail/iceweasel.profile
	rm -f firejail.1.gz
	gzip -9 firejail.1
	mkdir -p $(PREFIX)/share/man/man1
	install -c -m 0644 firejail.1.gz $(PREFIX)/share/man/man1/.	
	rm -f firejail.1.gz

uninstall:;
	rm -f $(PREFIX)/bin/firejail
	rm -fr $(PREFIX)/share/doc/firejail
	rm -fr $(PREFIX)/share/man/man1/firejail.1*
	
dist:
	mkdir $(NAME)-$(VERSION)
	cd $(NAME)-$(VERSION); cp -a ../* .; rm -fr $(NAME)-$(VERSION); make distclean; cd ..
	tar -cjvf $(NAME)-$(VERSION).tar.bz2 $(NAME)-$(VERSION)
	rm -fr $(NAME)-$(VERSION)

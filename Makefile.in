all: apps firejail.1
APPS = src/firejail src/firemon

PREFIX=@prefix@
VERSION=@PACKAGE_VERSION@
NAME=@PACKAGE_NAME@


.PHONY: apps $(APPS)
apps: $(APPS)
$(APPS):
	$(MAKE) -C $@

firejail.1: etc/firejail.txt
	./mkman.sh $(VERSION) etc/firejail.txt firejail.1

clean:;
	for dir in $(APPS); do \
		$(MAKE) -C $$dir clean; \
	done
	rm -f firejail.1 firejail.1.gz

distclean: clean
	for dir in $(APPS); do \
		$(MAKE) -C $$dir distclean; \
	done
	rm -fr Makefile autom4te.cache config.log config.status config.h

install: all
	strip src/firejail/firejail
	mkdir -p $(PREFIX)/bin
	install -c -m 0755 src/firejail/firejail $(PREFIX)/bin/.
	chmod u+s $(PREFIX)/bin/firejail
	strip src/firemon/firemon
	install -c -m 0755 src/firemon/firemon $(PREFIX)/bin/.
	mkdir -p $(PREFIX)/share/doc/firejail
	install -c -m 0644 COPYING $(PREFIX)/share/doc/firejail/.
	install -c -m 0644 README $(PREFIX)/share/doc/firejail/.
	install -c -m 0644 RELNOTES $(PREFIX)/share/doc/firejail/.
	mkdir -p /etc/firejail
	install -c -m 0644 etc/firefox.profile /etc/firejail/.
	install -c -m 0644 etc/firefox.profile /etc/firejail/iceweasel.profile
	rm -f firejail.1.gz
	gzip -9 firejail.1
	mkdir -p $(PREFIX)/share/man/man1
	install -c -m 0644 firejail.1.gz $(PREFIX)/share/man/man1/.	
	rm -f firejail.1.gz
	if [ ! -f /etc/firejail/sshd.users ]; \
		then @install -c m 0644 etc/sshd.users /etc/firejail/.; \
	fi

uninstall:;
	rm -f $(PREFIX)/bin/firejail
	rm -f $(PREFIX)/bin/firemon
	rm -fr $(PREFIX)/share/doc/firejail
	rm -fr $(PREFIX)/share/man/man1/firejail.1*
	
dist:
	make distclean
	rm -fr $(NAME)-$(VERSION) $(NAME)-$(VERSION).tar.bz2
	mkdir $(NAME)-$(VERSION)
	cd $(NAME)-$(VERSION); cp -a ../src .; cp -a ../etc .; cd ..
	cd $(NAME)-$(VERSION); cp -a ../configure .; cp -a ../configure.ac .; cp -a ../Makefile.in .; cp -a ../install.sh .; cp -a ../mkman.sh .; cd ..
	cd $(NAME)-$(VERSION); cp -a ../COPYING .; cp -a ../README .; cp -a ../RELNOTES .; cp -a ../ .; cp -a ../ .; cd ..
	cd $(NAME)-$(VERSION); rm -fr `find . -name .svn`; rm -fr $(NAME)-$(VERSION); cd ..
	tar -cjvf $(NAME)-$(VERSION).tar.bz2 $(NAME)-$(VERSION)
	rm -fr $(NAME)-$(VERSION)

* in user mode, --private=newdir, mask all other user directories in /home

* in overlay mode "sudo su -" doesn't work
etblue@ubuntu:~/work/firejail-sf$ firejail --overlay
Parent pid 4173, child pid 4174
Error: failed to unmount /sys
Interface           IP                  Mask                Status              
lo                  127.0.0.1           255.0.0.0           UP                  
eth0                192.168.1.47        255.255.255.0       UP                  

Child process initialized
[netblue@ubuntu firejail-sf]$ sudo su -
[sudo] password for netblue: 
su: System error
[netblue@ubuntu firejail-sf]$ 


* include /etc/firejail/iceweasel.profile into centos rpm


* list dbus sockets
sudo netstat -nap | grep dbus | grep CONNECTED | awk '{print $8}' | sort | uniq -c

* syscalls
/usr/include/x86_64-linux-gnu/bits/syscall.h
strace -f -c iceweasel

Trace files being opened by firefox
firejail strace -f -e open -o strace.out firefox


* libvirt-lxc:
 - /sys the host "sysfs" instance remounted read-only
 - /proc a new instance of the "proc" filesystem
 - /proc/sys the host "/proc/sys" bind-mounted read-only
 
* libvirt-lxc description
 http://libvirt.org/drvlxc.html#fsmounts
All containers are launched with the CAP_MKNOD capability cleared and removed from the bounding set. 
    /dev/zero
    /dev/null
    /dev/full
    /dev/random
    /dev/urandom
    /dev/stdin symlinked to /proc/self/fd/0
    /dev/stdout symlinked to /proc/self/fd/1
    /dev/stderr symlinked to /proc/self/fd/2
    /dev/fd symlinked to /proc/self/fd
    /dev/ptmx symlinked to /dev/pts/ptmx
    /dev/console symlinked to /dev/pts/0 
 
* lxc description:
Linux containers offer:
- chroot
- network isolation
- Shared memory isolation
- hostname/domainname per-container
- PID isolation (many container can see PID number 314 in each of them, however these are different PIDs on the host machine
- user mappings (map UID 433 on the host as UID 15 or UID 0 in the container)
- resource limit isolation
- CPU, Memory and I/O limits per-group
- Device isolation per-group
- there is a mechanism in the kernel to freeze/unfreeze all processes inside a container with a single command
- Fine grained capabilities per-container
- Tools: Docker, LXC and a lot of others.
- Live migration - CRIU. If certain rules are met, you can even live migrate a linux container to another physical machine.


lxc.cgroup.devices.deny = a # Deny all access to devices
lxc.cgroup.devices.allow = c 1:3 rwm # dev/null
lxc.cgroup.devices.allow = c 1:5 rwm # dev/zero
lxc.cgroup.devices.allow = c 5:1 rwm # dev/console
lxc.cgroup.devices.allow = c 5:0 rwm # dev/tty
lxc.cgroup.devices.allow = c 4:0 rwm # dev/tty0
lxc.cgroup.devices.allow = c 1:9 rwm # dev/urandom
lxc.cgroup.devices.allow = c 1:8 rwm # dev/random
lxc.cgroup.devices.allow = c 136:* rwm # dev/pts/*
lxc.cgroup.devices.allow = c 5:2 rwm # dev/pts/ptmx
# No idea what this is .. dev/bsg/0:0:0:0 ???
lxc.cgroup.devices.allow = c 254:0 rwm

* lxc-freeze and lxc-clone - using btrfs to take a snapshot of a frozen container and cloning it
https://blogs.oracle.com/OTNGarage/entry/linux_container_lxc_part_2

* https://www.stgraber.org/2013/12/21/lxc-1-0-your-second-container/
In such cases, “sudo lxc-freeze -n <container name>” can be used. That very simply freezes all the processes in the container
so they won’t get any time allocated by the scheduler. However the processes will still exist and will still use whatever memory
they used to.

Once you need the service again, just call “sudo lxc-unfreeze -n <container name>” and all the processes will be restarted.

* container usage
http://www.enterprisetech.com/2014/05/28/google-runs-software-containers/

* video device
/dev/video* 

* sound devices
/dev/dsp
/dev/adsp
/dev/audio
/dev/sndstat
/dev/mixer

$ ls /dev/snd
by-path  controlC0  pcmC0D0c  pcmC0D0p  pcmC0D1c  pcmC0D2p  seq  timer

$ lsusb --verbose | less

$ cat /dev/sndstat
Sound Driver:3.8.1a-980706 (ALSA v1.0.24 emulation code)
Kernel: Linux debian 3.2.0-4-amd64 #1 SMP Debian 3.2.57-3+deb7u2 x86_64
Config options: 0

Installed drivers: 
Type 10: ALSA emulation

Card config: 
Intel ICH with ALC655 at irq 23

Audio devices: NOT ENABLED IN CONFIG

Synth devices: NOT ENABLED IN CONFIG

Midi devices: NOT ENABLED IN CONFIG

Timers:
31: system timer

Mixers: NOT ENABLED IN CONFIG

$ lsmod | grep snd
snd_intel8x0           30903  2 
snd_ac97_codec        106942  1 snd_intel8x0
snd_pcm                68083  2 snd_ac97_codec,snd_intel8x0
snd_page_alloc         13003  2 snd_pcm,snd_intel8x0
snd_timer              22917  1 snd_pcm
snd                    52889  8 snd_timer,snd_pcm,snd_ac97_codec,snd_intel8x0
ac97_bus               12510  1 snd_ac97_codec
soundcore              13065  1 snd
netblue@debian:~/work/firejail/trunk$ lspci | grep Audio
00:10.2 Multimedia audio controller: NVIDIA Corporation MCP51 AC97 Audio Controller (rev a2)
netblue@debian:~/work/firejail/trunk$ 


* function interposition

 A few caveats before we close. First, LD_PRELOAD is ignored for programs with the SUID
 permission bits set for security reasons. Since function interposition lets you make a program
 do almost anything you want it to, Linux prevents you from modifying the behavior of a program
  running on behalf of another user or group. Second, you cannot interpose internal library 
  function calls, since these are resolved before runtime. For instance, if some function in libc 
  calls malloc, it will never call a wrapper function from a different library.

Aside from these limitations, function interposition is a very powerful technique that is useful
 for monitoring programs or modifying their behavior. Happy interposing! 
 	
 Library call interposition
 
* bug???
netblue@debian:~/work/firejail-sf$ firejail --trace svn commit -m "0.9.14 testing"
Parent pid 7848, child pid 7849
Interface           IP                  Mask                Status              
lo                  127.0.0.1           255.0.0.0           UP                  
eth0                192.168.1.60        255.255.255.0       UP                  
br0                 10.10.20.1          255.255.255.248     UP                  
br1                 10.10.30.1          255.255.255.0       UP                  
br2                 10.10.40.1          255.255.255.0       UP                  
br3                 10.10.50.1          255.255.255.0       UP                  

Child process initialized
1:bash:open /dev/tty
1:svn:open /etc/subversion/servers
1:svn:open /home/netblue/.subversion/servers
1:svn:open /etc/subversion/config
1:svn:open /home/netblue/.subversion/config
1:svn:open /home/netblue/work/firejail-sf/.svn/entries
1:svn:open /home/netblue/work/firejail-sf/.svn/entries
1:svn:open /home/netblue/work/firejail-sf/.svn/entries
1:svn:open /home/netblue/work/firejail-sf/.svn/entries
1:svn:open /home/netblue/work/firejail-sf/.svn/entries
1:svn:open /home/netblue/work/firejail-sf/.svn/lock
1:svn:open /home/netblue/work/firejail-sf/.svn/entries
1:svn:unlink /home/netblue/work/firejail-sf/.svn/lock
svn: Commit failed (details follow):
svn: '/home/netblue/work/firejail-sf/testing' is not under version control

parent is shutting down, bye...
